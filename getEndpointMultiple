import pandas as pd
import requests
from datetime import datetime


# region_id = 30000142

all_faction_items_list_1 = [
    15676,
    15677,
    15678,
    15681,
    15682,
    15683,
    15684,
    15685,
    15686,
    15687,
    15688,
    15689,
    15690,
    15691,
    15692,
    15693,
    15694,
    15695,
    15696,
    15697,
    15698,
    15699,
    15700,
    15701,
    15702,
    15703,
    15704,
    15705,
    15706,
    15707,
    15708,
    15709,
    15710,
    15711,
    15712,
    15713,
    15714,
    15715,
    15716,
    15717,
    15718,
    15719,
    15720,
    15721,
    15722,
    15723,
    15724,
    15725,
    15726,
    15727,
    15728,
    15729,
    15730,
    15731,
    15732,
    15733,
    15734,
    15735,
    15736,
    15737,
    15738,
    15739,
    15740,
    15741,
    15742,
    15743,
    15744,
    15745,
    15746,
    15747,
    15748,
    15749,
    15750,
    15751,
    15752,
    15753,
    15754,
    15755,
    15756,
    15757,
    15758,
    15759,
    15760,
    15761,
    15762,
    15764,
    15765,
    15766,
    15767,
    15768,
    15769,
    15770,
    15771,
    15772,
    15773,
    15774,
    15776,
    15777,
    15778,
    15779,
    15780,
    15781,
    15782,
    15783,
    15784,
    15785,
    15786,
    15787,
    15788,
    15789,
    15790,
    15791,
    15792,
    15793,
    15794,
    15795,
    15796,
    15797,
    15798,
    15799,
    15800,
    15801,
    15802,
    15803,
    15804,
    15805,
    15806,
    15807,
    15808,
    15809,
    15810,
    15811,
    15812,
    15813,
    15814,
    15815,
    15816,
    15817,
    15818,
    15819,
    15820,
    15821,
    15822,
    15823,
    15824,
    15825,
    15826,
    15827,
    15828,
    15829,
    15830,
    15831,
    15832,
    15833,
    15834,
    15835,
    15836,
    15837,
    15838,
    15839,
    15840,
    15841,
    15842,
    15843,
    15844,
    15845,
    15846,
    15847,
    15848,
    15849,
    15850,
    15851,
    15852,
    15853,
    15854,
    15855,
    15856,
    15857,
    15858,
    15859,
    15860,
    15861,
    15862,
    15863,
    15864,
    15865,
    15866,
    15867,
    15868,
    15869,
    15870,
    15871,
    15872,
    15873,
    15874,
    15875,
    15876,
    15877,
    15878,
    15879,
    15880,
    15881,
    15882,
    15883,
    15884,
    15885,
    15886,
    15887,
    15888,
    15889,
    15890,
    15891,
    15892,
    15893,
    15894,
    15895,
    15896,
    15897,
    15898,
    15899,
    15900,
    15901,
    15902,
    15903,
    15904,
    15905,
    15906,
    15907,
    15908,
    15909,
    15910,
    15911,
    15912,
    15913,
    15914,
    15915,
    15916,
    15917,
    15918,
    15919,
    15920,
    15921,
    15922,
    15923,
    15924,
    15925,
    15926,
    15927,
    15928,
    15929,
    15930,
    15931,
    15932,
    15933,
    15935,
    15936,
    15937,
    15938,
    15939,
    15940,
    15941,
    15942,
    15943,
    15945,
    15946,
    15947,
    15948,
    15949,
    15950,
    15951,
    15953,
    15954,
    15955,
    15956,
    15957,
    15958,
    15959,
    15960,
    15961,
    15962,
    15963,
    15964,
    15965,
    15966,
    15967,
    15968,
    16046,
    16047,
    16048,
    16049,
    16050,
    16051,
    16052,
    16053,
    16054,
    16055,
    16056,
    16057,
    16058,
    16059,
    16060,
    16061,
    16062,
    16063,
    16064,
    16065,
    16066,
    16067,
    16068,
    17484,
    17485,
    17486,
    17487,
    17488,
    17489,
    17490,
    17491,
    17492,
    17493,
    17494,
    17495,
    17496,
    17497,
    17498,
    17499,
    17500,
    17501,
    17502,
    17503,
    17504,
    17505,
    17506,
    17507,
    17508,
    17509,
    17510,
    17511,
    17512,
    17513,
    17514,
    17515,
    17516,
    17517,
    17518,
    17519,
    17520,
    17521,
    17522,
    17523,
    17524,
    17525,
    17526,
    17527,
    17528,
    17529,
    17536,
    17537,
    17538,
    17539,
    17540,
    17541,
    17542,
    17543,
    17544,
    17545,
    17546,
    17547,
    17548,
    17549,
    17550,
    17551,
    17552,
    17553,
    17554,
    17555,
    17556,
    17557,
    17558,
    17559,
    17561,
    17619,
    17620,
    17634,
    17635,
    17636,
    17637,
    17703,
    17704,
    17709,
    17710,
    17713,
    17714,
    17726,
    17727,
    17728,
    17729,
    17732,
    17733,
    17812,
    17813,
    17832,
    17833,
    17834,
    17835,
    17836,
    17837,
    17838,
    17839,
    17841,
    17842,
    17843,
    17844,
    19491,
    21740,
    21894,
    21896,
    21898,
    21900,
    21902,
    21904,
    21906,
    21908,
    21910,
    21912,
    21914,
    21916,
    21918,
    21920,
    21922,
    21924,
    21926,
    21928,
    21931,
    21933,
    21935,
    21937,
    21939,
    21941,
    22961,
    22963,
    22965,
    22967,
    22969,
    22971,
    22973,
    22975,
    22977,
    22979,
    22981,
    22983,
    22985,
    22987,
    22989,
    22991,
    22993,
    22995,
    22997,
    22999,
    23001,
    23003,
    23005,
    23007,
    23009,
    23011,
    23013,
    23015,
    23017,
    23019,
    23021,
    23023,
    23025,
    23027,
    23029,
    23031,
    23033,
    23035,
    23037,
    23039,
    23041,
    23043,
    23045,
    23047,
    23049,
    23051,
    23053,
    23071,
    23072,
    23073,
    23075,
    23077,
    23079,
    23081,
    23083,
    23085,
    23089,
    23091,
    23093,
    23095,
    23097,
    23099,
    23101,
    23103,
    23105,
    23107,
    23109,
    23111,
    23113,
    23115,
    23117,
    23119,
    27315,
    27321,
    27327,
    27333,
    27339,
    27345,
    27351,
    27359,
    27361,
    27371,
    27377,
    27381,
    27387,
    27395,
    27401,
    27405,
    27413,
    27419,
    27423,
    27429,
    27435,
    27441,
    27447,
    27453,
    27459,
    27465,
    27471,
    27477,
    27483,
    27489,
    27495,
    27501,
    27507,
    27513,
    27519,
    27525,
    28324,
    28325,
    28326,
    28327,
    28328,
    28329,
    28330,
    28331,
    28332,
    28333]

all_faction_items_list_2 = [
    28334,
    28335,
    28336,
    28337,
    28338,
    28339,
    28375,
    28376,
    28377,
    28378,
    28511,
    28512,
    28514,
    28515,
    28516,
    28517,
    28518,
    28519,
    28520,
    28521,
    28522,
    28523,
    28524,
    28525,
    28526,
    28527,
    28528,
    28529,
    28530,
    28531,
    28532,
    28533,
    28534,
    28535,
    28536,
    28537,
    28538,
    28539,
    28540,
    28541,
    28542,
    28543,
    28544,
    28545,
    28546,
    28547,
    28548,
    28549,
    28550,
    28551,
    28552,
    28553,
    28554,
    28555,
    28556,
    28557,
    28558,
    28559,
    28560,
    28561,
    28562,
    28563,
    28564,
    28565,
    28566,
    28739,
    28740,
    28741,
    28742,
    28743,
    28744,
    28745,
    28746,
    28747,
    29336,
    29337,
    29338,
    29339,
    29340,
    29341,
    29344,
    29345,
    31864,
    31865,
    31866,
    31867,
    31868,
    31869,
    31870,
    31871,
    31872,
    31873,
    31874,
    31875,
    31876,
    31877,
    31878,
    31879,
    31880,
    31881,
    31882,
    31883,
    31884,
    31885,
    31886,
    31887,
    31888,
    31889,
    31890,
    31891,
    31892,
    31893,
    31894,
    31895,
    31896,
    31897,
    31898,
    31899,
    31900,
    31901,
    31902,
    31903,
    31904,
    31905,
    31906,
    31907,
    31908,
    31909,
    31910,
    31911,
    31916,
    31917,
    31918,
    31919,
    31922,
    31923,
    31924,
    31925,
    31926,
    31927,
    31928,
    31929,
    31930,
    31931,
    31932,
    31933,
    31942,
    31943,
    31944,
    31945,
    31946,
    31947,
    31948,
    31949,
    31950,
    31951,
    31952,
    31953,
    32305,
    32306,
    32307,
    32308,
    32309,
    32310,
    32311,
    32312,
    32809,
    32810,
    33151,
    33152,
    33153,
    33154,
    33155,
    33156,
    33157,
    33158,
    33403,
    33404,
    33405,
    33406,
    33446,
    33447,
    33459,
    33460,
    33832,
    33842,
    33844,
    33850,
    33867,
    33868,
    37453,
    37454,
    37455,
    37456,
    37805,
    37820,
    40315,
    40316,
    40317,
    40318,
    41038,
    41061,
    41062,
    41212,
    41214,
    41215,
    41217,
    41218,
    41220,
    52929,
    52930,
    52931,
    52961,
    52962,
    52963,
    54006,
    54007,
    54008,
    54015,
    54016,
    54017,
    54024,
    54025,
    54026,
    54087,
    54088,
    54089,
    54096,
    54097,
    54098,
    54105,
    54106,
    54107,
    72811,
    72903,
    72904,
    72907,
    72913,
    72917,
    72919,
    72920,
    72922,
    72923,
    72924,
    72925,
    72926,
    73787,
    73789,
    73790,
    73792,
    73793,
    73794,
    73795,
    73796,
    73972,
    73973,
    73978,
    73979,
    73995,
    73996,
    73999,
    74000,
]

faction_ship_ids = [17634,
            17636,
            17703,
            17709,
            17713,
            17726,
            17728,
            17732,
            17812,
            17841,
            17843,
            29336,
            29337,
            29340,
            29344,
            32305,
            32307,
            32309,
            32311,
            33151,
            33153,
            33155,
            33157,
            37453,
            37454,
            37455,
            37456,
            72811,
            72812,
            72869,
            72872,
            72903,
            72904,
            72907,
            72913,
            73787,
            73789,
            73790,
            73792,
            73793,
            73794,
            73795,
            73796
            ]

regions_list = [
    10000001,
    10000002,
    10000003,
    10000004,
    10000005,
    10000006,
    10000007,
    10000008,
    10000009,
    10000010,
    10000011,
    10000012,
    10000013,
    10000014,
    10000015,
    10000016,
    10000017,
    10000018,
    10000019,
    10000020,
    10000021,
    10000022,
    10000023,
    10000025,
    10000027,
    10000028,
    10000029,
    10000030,
    10000031,
    10000032,
    10000033,
    10000034,
    10000035,
    10000036,
    10000037,
    10000038,
    10000039,
    10000040,
    10000041,
    10000042,
    10000043,
    10000044,
    10000045,
    10000046,
    10000047,
    10000048,
    10000049,
    10000050,
    10000051,
    10000052,
    10000053,
    10000054,
    10000055,
    10000056,
    10000057,
    10000058,
    10000059,
    10000060,
    10000061,
    10000062,
    10000063,
    10000064,
    10000065,
    10000066,
    10000067,
    10000068,
    10000069,
    10000070,
    10001000
]

selected_regions = {
                    10000002: "The Forge",
                    10000043: "Domain",
                    10000064: "Essence",
                    10000032: "Metropolis",
                    10000030: "Heimatar",
                    10000032: "Sinq Laison"
}





def get_multiple_market_histories(type_ids, region_id):
    print(type_ids, region_id)
    histories = {}
    for type_id in type_ids:
        print(type_id, region_id)
        try:
            histories[type_id] = get_market_history(type_id, region_id)
        except requests.HTTPError as e:
            print(f"Failed to fetch data for type ID {type_id}: {e}")
    return histories


def get_market_history(type_id, region_id=10000002):
    url = f"https://esi.evetech.net/latest/markets/{region_id}/history/?type_id={type_id}"
    response = requests.get(url)
    response.raise_for_status()  
    return response.json()


def process_market_data(histories):
    all_data = []
    for type_id, history in histories.items():
        for entry in history:
            entry['type_id'] = type_id
            all_data.append(entry)
    df = pd.DataFrame(all_data)
    # write_csv(df)
    return df


def write_csv(df):
    df.to_csv('output.csv', index=False)
    return



def start_multiple(data):
    start_time = datetime.now()
    counter = 0
    master_df = pd.DataFrame()
    for region in regions_list:
        region_history = get_multiple_market_histories(data, region)
        loop_df = process_market_data(region_history)
        print(type(loop_df))
        master_df = pd.concat([master_df, loop_df], ignore_index=True)
        print(loop_df.head())
        print('Completed', region)
        counter = counter + 1
        print (counter, " of 114 complete")
        end_time = datetime.now()
        print(end_time - start_time)
    master_df.to_csv('output.csv', index=False)

def start_selected(selected_regions, types):
    selected_regions_list = []
    for key, value in selected_regions.items():
        print(key, "selected")
        selected_regions_list.append(key)
    start_time = datetime.now()
    counter = 0
    master_df = pd.DataFrame()
    for region in selected_regions_list:
        region_history = get_multiple_market_histories(types, region)
        loop_df = process_market_data(region_history)
        print(type(loop_df))
        master_df = pd.concat([master_df, loop_df], ignore_index=True)
        print(loop_df.head())
        print('Completed', region)
        counter = counter + 1
        print(counter, "of", len(selected_regions_list))
        end_time = datetime.now()
        print(end_time - start_time)
    master_df.to_csv('output.csv', index=False)


# start_multiple(faction_ship_ids)

start_selected(selected_regions, faction_ship_ids)

